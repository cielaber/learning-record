# 计算机组成结构

## 计算机结构

![1739800132873](./images/1739800132873.png)

### CPU组成

**运算器**

1. 算术逻辑单元ALU：数据的算术运算和逻辑运算
2. 累加寄存器AC：通用寄存器，为ALU提供一个工作区，用于暂存数据
3. 数据缓冲寄存器DR：写内存时，暂存指令或数据
4. 状态条件寄存器PSW：存状态标志与控制标志

**控制器**

1. 程序计数器PC：存储下一条要执行指令的地址
2. 指令寄存器IR：存储即将要执行的指令
3. 指令译码器ID：对指令中的操作码字段进行分析解释
4. 时序部件：提供时序控制信号

### 冯·诺依曼结构和哈佛结构

**冯·诺依曼结构**

冯·诺依曼结构也称普林斯顿结构，是一种将程序指令存储器和数据存储器合并在一起的存储结构。

特点：

- 一般用于PC处理器，如I3、I5、I7处理器
- 指令与数据存储器合并在一起
- 指令与数据都通过相同的数据总线传输

**哈佛结构**
哈佛结构是一种将指令存储和数据存储分开的存储器结构。哈佛结构是一种并行体系结构，它的主要特点是将程序和数据存储在不同的存储空间中，即程序存储器和数据存储器是两个独立的存储器，每个存储器独立编址、独立访问。

特点：

- 一般用于嵌入式系统处理器、数字信号处理器（DSP）
- 指令与数据分开存储，可以并行读取，有较高的数据吞吐率
- 有4条总线：指令的数据总线、指令的地址总线、数据的数据总线、数据的地址总线

**嵌入式-芯片**

![1743330228320](./images/1743330228320.png)

### 存储系统-层次化存储结构

![1743330442112](./images/1743330442112.png)

#### Cache

提高CPU数据输入输出的速率，突破冯诺依曼瓶颈，即CPU与存储系统之间数据传输带宽限制。

在计算机的存储系统中，Cache是访问速度最快的。

Cache对程序员来说是透明的。

使用Cahce改善系统性能的依据是程序的局部性原理：时间局部性、空间局部性。

##### 局部性原理

**时间局部性**

指程序中的某条指令一旦执行，不久之后该指令可能再次执行，典型原因是由于程序中存在大量的循环操作。

**空间局部性**

指程序一旦访问了某个存储单元，不久之后，其附近的单元也将被访问，即程序在一段时间内所访问的地址可能集中在一定的范围内，其典型的情况是程序的顺序执行。

Cache 通常分为三级（现代 CPU）：

- **L1 Cache**（一级缓存）：速度最快，容量最小（KB 级），每个 CPU 核心独享。
- **L2 Cache**（二级缓存）：速度稍慢，容量较大（MB 级），可能共享或独享。
- **L3 Cache**（三级缓存）：速度较慢，容量更大（MB 级），通常由多个核心共享。

##### Cache 的访问机制

当 CPU 需要读取数据时，会按照以下顺序查找：

1. **L1 Cache** → 命中？直接返回数据（1-3 个时钟周期）
2. **L2 Cache** → 命中？返回数据（约 10 个周期）
3. **L3 Cache** → 命中？返回数据（约 30-50 个周期）
4. **RAM（主存）** → 若都不命中，从 RAM 读取（约 100-300 个周期）

如果数据最终在 RAM 中都不存在（例如被换出到磁盘），还会触发**缺页中断（Page Fault）**，导致更严重的延迟（毫秒级）。

##### Cache命中率

命中率是指 CPU 访问 Cache 时，数据在 Cache 中找到的概率。

如果以h代表对Cache的访问命中率，t表示Cache的周期时间，t,表示主存储器周期时间，以读操作为例，使用“Cache+主存储器”的系统的平均周期为t3,则：**t3=h×t1+(1-h)Xt2**，其中，(1-h)又称为失效率(未命中率)。

##### 影响 Cache 命中率的因素

**Cache 大小**

- Cache 越大，能存储的数据越多，命中率越高。

- 但 Cache 成本高，不能无限增大。

**Cache 替换策略**

当 Cache 满时，需要决定**替换哪些数据**，常见策略：

- LRU（Least Recently Used）：替换最久未使用的数据（命中率高，但实现复杂）。
- FIFO（First-In-First-Out）：替换最早进入的数据（简单，但命中率较低）。
- Random：随机替换（简单，但性能不稳定）。

**程序访问模式**

- 局部性好的程序（如循环访问数组）→ 高命中率。
- 随机访问的程序（如哈希表查询）→ 低命中率。

#### 工作集理论

工作集（Working Set）或驻留集是计算机操作系统中一个重要的内存管理概念，指的是一个进程在某段时间间隔内实际需要访问的页面集合。

在理解工作集之前，需要先明白"页面"（Page）的概念：

- **页面是虚拟内存管理的基本单位**：现代操作系统使用虚拟内存技术，将程序使用的内存地址（虚拟地址）映射到实际的物理内存地址。这种映射不是以字节为单位，而是将内存划分为固定大小的块，称为"页面"。
- **典型页面大小**：通常是4KB（但不同系统可能不同，如2KB、8KB或更大）
- **页面与物理内存**：当程序访问某个虚拟地址时，操作系统会检查该地址所在的页面是否已加载到物理内存中。如果没有，则会发生"页面错误"（Page Fault），需要从磁盘调入该页面。

**工作集的作用**

1. **防止抖动（Thrashing）**：当系统内存不足时，操作系统可能频繁地将页面换入换出，导致CPU大部分时间用于处理页面调度而非实际工作，这种现象称为"抖动"。合理的工作集大小可以帮助避免这种情况。
2. **内存分配依据**：操作系统可以根据进程的工作集大小来决定为其分配多少物理内存。
3. **页面置换策略**：工作集模型指导哪些页面应该保留在内存中，哪些可以置换出去。

**页面置换机制**：

- 当物理内存不足时，操作系统会将部分内存页**换出**到磁盘。
- 这些被换出的页面虽然"属于"进程，但实际不在物理内存中。
- 当进程再次访问这些页面时，会产生**缺页中断**(Page Fault)，需要从磁盘重新加载。

此外，工作集管理的"物理内存" = RAM。Cache是CPU内部的优化，独立于操作系统的内存管理。

工作集机制避免了频繁的**RAM↔磁盘**交换，而Cache机制避免了频繁的**CPU↔RAM**访问，二者协同提升性能。
