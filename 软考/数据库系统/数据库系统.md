# 数据库系统

## 数据库模式

美国国家标准协会(American National Standard Institute, ANSI)的数据库管理系统研究小组于1978年提出了标准化的建议，将数据库结构分为3级：面向用户或应用程序员的用户级、面向建立和维护数据库人员的概念级、面向系统程序员的物理级。

![image-20250603175243734](.\images\image-20250603175243734.png)

数据按外模式的描述提供给用户；按内模式的描述存储在磁盘上；而概念模式提供了连接这两级模式的相对稳定的中间层，并使得两级中任意一级的改变都不受另一级的牵制。

### 数据独立性

数据的独立性是指数据与程序独立，将数据的定义从程序中分离出来，由DBMS（数据库管理系统）负责数据的存储，从而简化应用程序，大大减少应用程序编制的工作量。

数据库的三级模式结构和二级映射是数据库系统实现数据独立性的核心设计理念。

**数据的物理独立性**

数据的物理独立性是指当数据库的内模式发生改变时，数据的的逻辑结构不变。由于应用程序处理的只是数据的逻辑结构，这样物理独立性可以保证，当数据的物理结构改变了，应用程序不用改变。

但是，为了保证应用程序能够正确执行，需要修改概念模式/内模式之间的映像。

**数据的逻辑独立性**

数据的逻辑独立性是指用户的应用程序与数据库结构是相互独立的。数据的逻辑结构发生变化后，用户程序也可以不修改。

但是，为了保证应用程序能够正确执行，需要修改外模式/概念模式之间的映像。

### 三级模式

#### 概念模式

概念模式又称模式或逻辑模式，对应于概念级。它是由数据库设计者综合所有用户的数据，按照统一的观点构造的全局逻辑结构，是对数据库中全部数据的逻辑结构和特征的总体描述，是所有用户的公共数据视图(全局视图)。它是由数据库管理系统提供的数据模式描述语言(Data Description Language，DDL)来描述、定义的。

模式处于三级结构的中间层，不涉及数据的物理存储细节和硬件环境，与具体的应用程序、所使用的应用开发工具及高级程序设计语言无关。一个数据库只有一个模式，因为它是整个数据库数据在逻辑上的视图，即是数据库的整体逻辑。

例如：学生信息管理系统的模式定义了`学生表(学号, 姓名, 性别, 出生日期, 院系)`、`课程表(课程号, 课程名, 学分)`、`选课表(学号, 课程号, 成绩)`等结构及其关系。

#### 外模式

外模式又称子模式或用户模式，对应于用户级。它是某个或某几个用户所看到的数据库的数据视图，是与某一应用有关的数据的逻辑表示。外模式是从模式导出的一个子集，包含模式中允许特定用户使用的那部分数据。用户可以通过外模式描述语言来描述、定义对应于用户的数据记录(外模式)，也可以利用数据操纵语言(Data Manipulation Language，DML)对这些数据记录进行操作。

例如，一个学生信息管理系统中：

- 学生本人登录后看到的视图可能只包含他自己的基本信息、选课成绩（外模式1）。
- 教务处老师看到的视图可能包含所有学生的信息、所有课程信息、教师信息（外模式2）。
- 财务处看到的视图可能只包含学生的学号、姓名、缴费状态（外模式3）。

#### 内模式

内模式又称存储模式，对应于物理级。它是数据库中全体数据的内部表示或底层描述，是数据库最低一级的逻辑描述，它描述了数据在存储介质上的存储方式和物理结构，对应着实际存储在外存储介质上的数据库。内模式由内模式描述语言来描述、定义的。

例如，内模式规定：

- `学生表`的数据存储在名为`student.dat`的文件中，按`学号`升序组织成B+树结构。
- 在`姓名`字段上建立一个辅助的哈希索引。
- 每条记录采用定长格式存储。
- 数据块大小为4KB。

### 两级映射

#### 外模式-概念模式的映射

模式描述的是数据的全局逻辑结构，外模式描述的是数据的局部逻辑结构。数据库中的同一模式可以有任意多个外模式，对于每个外模式，都存在一个外模式/模式映像，它确定了数据的局部逻辑结构与全局逻辑结构之间的对应关系。

当概念模式（全局逻辑结构）发生改变时（如增加一个新字段、修改字段类型），数据库管理员(DBA)可以通过修改这个映射关系，使得外模式（用户视图）保持不变。这样，依赖于该外模式的应用程序就不需要修改。

保证了逻辑数据独立性 (Logical Data Independence) - 应用程序不受全局逻辑结构变化的影响。

例如：在`学生表`的模式中，需要将`姓名`字段拆分成`姓氏`和`名字`两个字段（比如为了支持国际化需求）。

传统文件系统做法：所有读取或写入`姓名`字段的程序都必须修改代码，以适应新的两个字段结构。工作量巨大！

数据库三级模式做法：

1. DBA 修改概念模式：将`学生表`定义改为`(学号, 姓氏, 名字, 性别, 出生日期, 院系)`。
2. DBA 修改相关的外模式/概念模式映射。
   1. 对于只需要`姓名`（原样显示）的外模式：映射中定义 `姓名 = 姓氏 + ' ' + 名字`。这样，该外模式看到的仍然是一个叫`姓名`的字段，内容由拼接而成。
   2. 对于需要区分姓氏和名字的外模式：映射直接暴露新的`姓氏`和`名字`字段。
3. 那些只使用旧`姓名`字段的外模式（及其对应的应用程序）完全不需要修改，因为映射保证了它们看到的视图没有变化（还是那个拼接好的`姓名`字段）。依赖于能看到新字段的外模式的程序才需要修改。

全局逻辑结构（概念模式）变了，但很多应用程序（通过外模式访问）完全不受影响。程序独立于数据的逻辑结构变化。

#### 概念模式-内模式的映射

数据库中的模式和内模式只有一个，所以模式/内模式映像是唯一的。它确定了数据的全局逻辑结构与储存逻辑结构之间的对应关系。

当内模式（物理存储结构）发生改变时（如更换存储设备、改变文件组织方式、创建新的索引），DBA可以通过修改这个映射关系，使得概念模式（全局逻辑结构）保持不变。这样，所有的外模式和应用程序都不需要修改。

保证了物理数据独立性 (Physical Data Independence) - 应用程序和全局逻辑结构不受物理存储变化的影响。

例如：为了提高查询性能，DBA决定为`选课表`在`成绩`字段上创建一个新的B+树索引，并将数据文件从硬盘A迁移到更快的固态硬盘B上。

传统文件系统做法：如果程序直接操作文件路径和访问方法（如顺序扫描），那么：

- 程序可能需要修改文件路径指向硬盘B。
- 如果程序原本依赖顺序扫描，现在想利用新索引加速，必须修改程序代码来使用新的索引访问方式。

数据库三级模式做法：

1. DBA 修改内模式：
   - 更新索引定义（增加`成绩`索引）。
   - 更改`选课表`数据文件的物理位置（指向硬盘B上的新文件）。
   - （可能）调整文件组织方式。
2. DBA 修改概念模式/内模式映射：将新的物理存储细节（文件位置、索引）映射到原有的逻辑模式`选课表(学号, 课程号, 成绩)`上。
3. 概念模式（逻辑结构）保持不变！所有外模式自然也保持不变。应用程序发出的SQL查询（如`SELECT * FROM 选课表 WHERE 成绩 > 90;`）完全不需要修改。数据库管理系统(DBMS)会自动通过更新后的模式/内模式映射找到新的索引和文件位置，优化查询执行路径。

物理存储结构（内模式）发生了重大变化（迁移存储、新增索引），但应用程序完全感知不到，也不需要做任何修改。DBMS利用映射自动处理了物理细节。程序独立于数据的物理存储变化。

## 分布式数据库

分布式数据库（Distributed Database）一种将数据分布存储在多个物理上分散的数据库单元中，并通过网络将这些数据单元组成的逻辑上的统一整体的数据库系统。它的核心思想是将数据分布在多个节点上，每个节点可以独立处理一部分数据，且各个节点之间可以协同工作，共同完成用户的存储和处理操作。

分布式数据库系统的设计目标主要包括：性能、可扩展性、高可用性、容错性和一致性。通过将数据分布在多个节点上，分布式数据库可以通过增加节点来扩展系统的存储和计算能力，解决单机数据库在处理海量数据时的性能瓶颈。此外，分布式数据库还通过冗余和副本机制提高了系统的容错性和可靠性，确保即使某些节点出现故障，系统仍能正常工作。

**特点**

- 数据独立性。除了数据的逻辑独立性和物理独立性外，分布式数据库还有数据分布式独立的特点。
- 集中与自治共享结合的控制结构。各局部的DBMS可以独立地管理局部数据库，具有自治的功能。同时，系统又设有集中控制机制，协调各局部DBMS的工作，执行全局应用。
- 适当增加数据冗余度。在不同的场地存储同一数据的多个副本，可以适当提高系统的可靠性和可用性，同时也能提高系统性能。即当系统中某个节点发生故障时，由于数据存在副本，对其他地方来说，数据仍然是可用的，从而保证数据的完备性。
- 全局一致性、可串行性和可恢复性

**劣势**

- 通信开销大，故障率高
- 数据的存取结构复杂
- 数据的安全性和保密性难以控制
- 数据一致性和事务处理复杂

### 分布式数据库管理系统DDBMS

![image-20250603185854088](.\images\image-20250603185854088.png)

分布式数据库管理系统（Distributed Database Management System，简称DDBMS）是一种在计算机网络上由多台计算机共同参与数据的管理的系统。这种系统允许数据分布在不同的物理位置，但对用户来说，操作和访问就像使用一个单一的数据库一样。 

分布式数据库管理系统的基本功能包括接受用户请求、访问网络数据字典、执行分布式处理、在用户和局部DBMS之间进行协调，以及在异构环境中提供数据和进程移植的支持。

**组成**

- 局部数据库管理系统LDBMS
- 全局数据库管理系统GDBMS
- 全局数据字典
- 通信管理CM

**结构**

- 全局控制集中的DDBMS
- 全局控制分散的DDBMS
- 全局控制部分分散的DDBMS

透明性

### 透明性

透明性是分布式数据库的属性，通过它，分布的内部细节对用户隐藏。 DDBMS 设计者可以选择对表进行分段、复制分段并将它们存储在不同的站点。 然而，由于用户忽略了这些细节，他们发现分布式数据库像任何集中式数据库一样易于使用。

#### 逻辑透明性

逻辑透明性，也称局部映像透明性，指的是用户无需关心不必关心局部DBMS支持哪种数据模型、使用哪种数据操纵语言，系统会通过逻辑层来统一处理。也就是说，用户在访问数据时，系统会将其视为一个逻辑上的整体，而不需要知道数据是分布在多个位置、设备或节点上的，也不需要知道各个局部具体的细节。这种透明性对用户来说非常重要，因为它提供了一个简洁、统一的视图。

例如，在分布式数据库中，用户可以像在单一数据库中一样查询数据，而不需要关心数据是存储在不同服务器上以及不同服务器上的存储结构和方式，或者如何通过不同的计算节点来处理查询。

#### 分片透明性

分片透明性指的是数据在数据库中如何进行分片（即将数据拆分到多个部分）对用户来说是透明的。分片通常是为了提高查询效率和负载均衡。分片透明性保证了应用程序在访问数据库时，不需要关心数据是如何被分割的，以及每个分片的具体内容。

例如，在一个分布式数据库中，数据表可能被分成多个部分（分片），用户在进行查询时，系统自动根据规则决定哪些分片包含需要的数据，用户无需显式地指定查询哪个分片。

数据分片有如下三种方式：

- 水平分片：按照数据内容进行分片，比如按照数据的地域属性进行将数据进行分布到不同的地方。
- 垂直分片：按照数据结构进行分片，比如按照字段将不同字段数据分布在到不同的地方。
- 混合分片：水平分片和垂直分片同时使用。

#### 位置透明性

位置透明性意味着用户不需要知道数据的实际存储位置，也就是数据的物理位置对用户是完全透明的。在分布式数据库中，数据可以分布在不同的服务器或地理位置，用户和应用程序在访问数据时，完全不需要考虑这些数据存储在哪里。

例如，用户查询数据时，不需要知道数据是存储在纽约的服务器还是在东京的服务器。无论数据的存放位置如何，用户看到的结果是一样的。

#### 复制透明性

复制透明性意味着用户和应用程序不需要知道数据是否被复制，复制的数据是透明的。分布式数据库中，数据可能会被复制到多个节点或服务器，以确保高可用性、容错性和负载均衡。复制透明性保证了在数据复制的情况下，用户无需关心复制的机制或副本的数量。 

例如，如果一个数据库的某个数据项被复制到多个位置，用户无论是访问主副本还是副本，都能够得到一致的结果。系统会自动处理读写请求的路由，而用户不需要关心具体的复制策略。

### 两阶段提交协议-2PC

二阶段提交(Two-phaseCommit)是指，在计算机网络以及数据库领域内，为了使基于分布式系统架构下的所有节点在进行事务提交时保持一致性而设计的一种算法(Algorithm)。通常，二阶段提交也被称为是一种协议(Protocol))。

在分布式系统中，每个节点虽然可以知晓自己的操作时成功或者失败，却无法知道其他节点的操作的成功或失败。

当一个事务跨越多个节点时**，**为了保持事务的ACID特性，需要引入一个作为协调者的组件来统一掌控所有节点(称作参与者)的操作结果并最终指示这些节点是否要把操作结果进行真正的提交(比如将更新后的数据写入磁盘等等)。

因此，二阶段提交的算法思路可以概括为：参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作。

两个阶段是指：

- voting phase **投票阶段**：该阶段，协调者将通知事务参与者准备提交或取消事务，然后进入表决过程。在表决过程中，参与者将告知协调者自己的决策：同意（事务参与者本地作业执行成功）或取消（本地作业执行故障）。
- commit phase **提交阶段**：该阶段，协调者将基于第一个阶段的投票结果进行决策：提交或取消。当且仅当所有的参与者同意提交事务协调者才通知所有的参与者提交事务，否则协调者将通知所有的参与者取消事务。参与者在接收到协调者发来的消息后将执行响应的操作。

> 三阶段提交（Three-phase commit），也叫三阶段提交协议（Three-phase commit protocol），是二阶段提交（2PC）的改进版本。
>
> 与两阶段提交不同的是，三阶段提交有两个改动点。
>
> - 引入超时机制。同时在协调者和参与者中都引入超时机制。
> - 在第一阶段和第二阶段中插入一个准备阶段，主要是为了在预执行之前，确保所有参与者都具备可执行条件，从而减少资源浪费，保证了在最后提交阶段之前各参与节点状态的一致。
>
> 相对于2PC，3PC主要解决的单点故障问题，并减少阻塞。

**例题**

![image-20250603195102586](.\images\image-20250603195102586.png)

答案：D

![image-20250603195218029](.\images\image-20250603195218029.png)

答案：D

![image-20250603195311707](.\images\image-20250603195311707.png)

答案：C